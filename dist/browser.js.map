{"version":3,"sources":["constants.js","index.js","browser.js"],"names":["SEPARATOR","FINGERPRINT_ALGO","name","SYM_ALGO","length","ASYM_ALGO","modulusLength","publicExponent","Uint8Array","hash","URLS","production","sandbox","staging","test","local","module","exports","require","DidwwEncryptedFile","content","toString","toFile","buildFile","toArrayBuffer","stringToArrayBuffer","logError","message","console","error","fetchPublicKeys","url","fetch","then","response","json","keys","key_a","key_b","cryptoFingerprint","text","digestAlgo","textBuff","sha1Func","crypto","subtle","digest","bind","digestBuff","arrayBufferToHexString","calculateFingerprint","pemPublicKeys","publicKeysBase64","map","pemPubKey","PemToBase64Key","fingerprints","atob","result","push","_","join","str","buf","ArrayBuffer","bufView","i","charCodeAt","hexStringToArrayBuffer","hexString","intArray","match","byte","parseInt","buffer","arrayBufferToString","bytes","reduce","String","fromCharCode","byteString","type","window","navigator","msSaveBlob","file","Blob","lastModifiedDate","Date","File","lastModified","readFileContent","Promise","resolve","reject","reader","FileReader","onload","onerror","readAsDataURL","generateKey","cryptoKey","exportKey","keyBuffer","encryptAES","key","ivBufView","getRandomValues","salt","repeat","importKey","encrypt","iv","encryptedBuffer","encryptedContent","btoa","aesKey","split","slice","encryptRSA","pubKeyBase64","catch","DidwwEncrypt","options","environment","publicKeysUrl","publicKeys","fingerprint","getPublicKeys","getFingerprint","clearCache","encryptContent","fileContent","asymKeys","symKey","symEncryptedContent","symEncryptedKey","encryptedParts","concat","encryptFile","encryptArrayBuffer","binary"],"mappings":"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","file":"browser.js","sourceRoot":"../src","sourcesContent":["const SEPARATOR = \":::\"\nconst FINGERPRINT_ALGO = { name: \"sha-1\" }\nconst SYM_ALGO = { name: \"AES-CBC\", length: 256 }\nconst ASYM_ALGO = {\n    name: \"RSA-OAEP\",\n    modulusLength: 4096,\n    publicExponent: new Uint8Array([1, 0, 1]),\n    hash: { name: \"SHA-256\" }\n}\nconst URLS = {\n    production: 'https://my.didww.com/public_keys',\n    sandbox: 'https://my-sandbox.didww.com/public_keys',\n    staging: 'https://my-staging.didww.com/public_keys',\n    test: null,\n    local: ''\n}\n\nmodule.exports = {\n    SEPARATOR,\n    FINGERPRINT_ALGO,\n    SYM_ALGO,\n    ASYM_ALGO,\n    URLS\n}\n","const {\n    SEPARATOR,\n    FINGERPRINT_ALGO,\n    SYM_ALGO,\n    ASYM_ALGO,\n    URLS\n} = require('./constants')\n\nfunction DidwwEncryptedFile (content) {\n    this.toString = () => content\n    this.toFile = (name) => buildFile(content, name || 'file.enc', 'text/plain')\n    this.toArrayBuffer = () => stringToArrayBuffer(content)\n}\n\nfunction logError(message) {\n    if (console && console.error) console.error(message)\n}\n\nfunction fetchPublicKeys(url) {\n    return fetch(url)\n        .then(response => response.json())\n        .then(keys => [keys.key_a, keys.key_b])\n}\n\nfunction cryptoFingerprint (text, digestAlgo) {\n    var textBuff = stringToArrayBuffer(text);\n    var sha1Func = crypto.subtle.digest.bind(crypto.subtle, digestAlgo);\n    return sha1Func(textBuff)\n        .then(digestBuff => arrayBufferToHexString(digestBuff))\n}\n\nfunction calculateFingerprint(pemPublicKeys) {\n    let publicKeysBase64 = pemPublicKeys.map(pemPubKey => PemToBase64Key(pemPubKey))\n    let fingerprints = []\n    return cryptoFingerprint(atob(publicKeysBase64[0]), FINGERPRINT_ALGO)\n        .then(result => fingerprints.push(result))\n        .then(_ => cryptoFingerprint(atob(publicKeysBase64[1]), FINGERPRINT_ALGO))\n        .then(result => fingerprints.push(result))\n        .then(_ => fingerprints.join(SEPARATOR))\n}\n\nfunction stringToArrayBuffer(str) {\n    let buf = new ArrayBuffer(str.length)\n    let bufView = new Uint8Array(buf)\n    for (let i = 0; i < str.length; i++) {\n        bufView[i] = str.charCodeAt(i)\n    }\n    return buf\n}\n\nfunction hexStringToArrayBuffer (hexString) {\n    let intArray = hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16))\n    return new Uint8Array(intArray).buffer\n}\n\nfunction arrayBufferToString (buf) {\n    let bytes = new Uint8Array(buf)\n    return bytes.reduce((str, byte) => str + String.fromCharCode(byte), \"\")\n}\n\nfunction arrayBufferToHexString (buf) {\n    let bytes = new Uint8Array(buf)\n    return bytes.reduce((hexString, byte) => {\n        let byteString = byte.toString(16)\n        if (byteString.length === 1) {\n            byteString = '0' + byteString\n        }\n        return hexString + byteString\n    }, \"\");\n}\n\nconst buildFile = (content, name, type) => {\n    // Edge browser does not support File\n    if (window && window.navigator && window.navigator.msSaveBlob) {\n        let file = new Blob([content], {type: type});\n        file.lastModifiedDate = new Date();\n        file.name = name;\n        return file;\n    }\n\n    return new File([content], name, {type: type, lastModified: new Date()})\n}\n\nfunction readFileContent (file) {\n    return new Promise((resolve, reject) => {\n        let reader = new FileReader()\n        reader.onload = () => resolve(reader.result)\n        reader.onerror = () => reject(reader.error)\n        reader.readAsDataURL(file)\n    })\n}\n\nfunction generateKey () {\n    return crypto.subtle.generateKey(\n        SYM_ALGO,\n        true,\n        [\"encrypt\", \"decrypt\"]\n    ).then(cryptoKey => {\n        return crypto.subtle.exportKey(\"raw\", cryptoKey)\n            .then(keyBuffer => arrayBufferToHexString(keyBuffer))\n    })\n}\n\nfunction encryptAES (key, content) {\n    let keyBuffer = hexStringToArrayBuffer(key)\n    let ivBufView = crypto.getRandomValues(new Uint8Array(16))\n    let salt = '0'.repeat(16)\n\n    return crypto.subtle.importKey(\n        \"raw\",\n        keyBuffer,\n        { name: SYM_ALGO.name },\n        false,\n        [\"encrypt\", \"decrypt\"]\n    ).then(cryptoKey => {\n        return crypto.subtle.encrypt(\n            { name: SYM_ALGO.name, iv: ivBufView },\n            cryptoKey,\n            stringToArrayBuffer(content)\n        ).then(encryptedBuffer => {\n            // add first 16 bytes salt for backward compatibility old encrypted data.\n            let encryptedContent = btoa(salt + arrayBufferToString(encryptedBuffer))\n            let aesKey = [key, arrayBufferToHexString(ivBufView.buffer)].join(SEPARATOR)\n            return { key: aesKey, content: encryptedContent }\n        })\n    })\n}\n\nfunction PemToBase64Key (pemPubKey) {\n    // pemPubKey should look like this\n    // \"-----BEGIN PUBLIC KEY-----\\n<pubKeyBase64>\\n-----END PUBLIC KEY-----\\n\"\n    if (pemPubKey[pemPubKey.length - 1] !== \"\\n\") pemPubKey = pemPubKey + \"\\n\"\n    return pemPubKey.split(\"\\n\").slice(1, -2).join(\"\")\n}\n\nfunction encryptRSA(pemPubKey, content) {\n    let pubKeyBase64 = PemToBase64Key(pemPubKey)\n\n    return crypto.subtle.importKey(\n        \"spki\",\n        stringToArrayBuffer(atob(pubKeyBase64)),\n        ASYM_ALGO,\n        false,\n        [\"encrypt\"]\n    ).then(function (cryptoKey) {\n        return crypto.subtle.encrypt(\n            {\n                name: ASYM_ALGO.name,\n                hash: ASYM_ALGO.hash\n            },\n            cryptoKey,\n            stringToArrayBuffer(content)\n        ).then(function (encryptedBuffer) {\n            return btoa(arrayBufferToString(encryptedBuffer))\n        }).catch(function (error) {\n            logError(\"Failed to encrypt with RSA pubKey\", error)\n            return null\n        })\n    }).catch(function (error) {\n        logError(\"Failed to import RSA pubKey\", error)\n        return null\n    })\n}\n\nfunction DidwwEncrypt(options) {\n    // todo validate options (allow environment, publicKeys)\n    let environment = options.environment\n    let url = options.url || URLS[environment]\n    let publicKeysUrl = url + '/public_keys'\n    let publicKeys = null\n    let fingerprint = null\n    if (environment === 'test') {\n        publicKeys = options.publicKeys\n    }\n\n    this.getPublicKeys = () => {\n        if (publicKeys) return new Promise(resolve => resolve(publicKeys))\n\n        return fetchPublicKeys(publicKeysUrl)\n            .then(result => {\n                publicKeys = result\n                return publicKeys\n            })\n    }\n    this.getFingerprint = () => {\n        if (fingerprint) return new Promise(resolve => resolve(fingerprint))\n\n        return this.getPublicKeys()\n            .then(keys => calculateFingerprint(keys))\n            .then(result => {\n                fingerprint = result\n                return fingerprint\n            })\n    }\n    this.clearCache = () => {\n        publicKeys = null\n        fingerprint = null\n    }\n    this.encryptContent = fileContent => {\n        let asymKeys = null\n        let symKey = null\n        let symEncryptedContent = null\n        let symEncryptedKey = null // { content, key }\n        let encryptedParts = []\n\n        return this.getPublicKeys().then(result => asymKeys = result)\n            .then(\n                _ => generateKey().then(result => symKey = result)\n            )\n            .then(\n                _ => encryptAES(symKey, fileContent).then(result => {\n                    symEncryptedContent = result.content\n                    symEncryptedKey = result.key\n                })\n            )\n            .then(\n                _ => encryptRSA(asymKeys[0], symEncryptedKey).then(result => encryptedParts.push(result))\n            )\n            .then(\n                _ => encryptRSA(asymKeys[1], symEncryptedKey).then(result => encryptedParts.push(result))\n            )\n            .then(_ => {\n                return new DidwwEncryptedFile(\n                    encryptedParts.concat(symEncryptedContent).join(SEPARATOR)\n                )\n            })\n    }\n    this.encryptFile = file => {\n        return readFileContent(file).then(this.encryptContent)\n    }\n    this.encryptArrayBuffer = buffer => {\n        let binary = arrayBufferToString(buffer)\n        return this.encryptContent(binary)\n    }\n}\n\nDidwwEncrypt['DidwwEncryptedFile'] = DidwwEncryptedFile\nDidwwEncrypt['SYM_ALGO'] = SYM_ALGO\nDidwwEncrypt['ASYM_ALGO'] = ASYM_ALGO\n\n// export default DidwwEncrypt\nmodule.exports = DidwwEncrypt\n","window.DidwwEncrypt = require('./index')\n"]}